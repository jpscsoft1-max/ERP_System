<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script>
    // Redirect to login if not logged in
    if (localStorage.getItem("isLoggedIn") !== "true") {
      window.location.href = "login.html";
    }
  </script>
  <style>
    body {
      margin: 0;
      background-color: #f4f6f8;
    }

    table {
      border-collapse: collapse;
      width: 80%;
      margin-top: 20px;
      background-color: #f9f9f9;
      font-family: Arial, sans-serif;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    table th,
    table td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: center;
    }

    table thead {
      background-color: #f0f0f0;
      color: rgb(36, 36, 36);
    }

    table tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    table tbody tr:hover {
      background-color: #e0f7fa;
      cursor: pointer;
    }

    /* Meeting Section Styles */
    .meeting-section {
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      padding: 20px;
      width: 100%;
      margin-top: 40px;
      margin-bottom: 40px;
    }

    .meeting-section h2 {
      margin-top: 0;
    }

    .meeting-controls {
      margin-bottom: 20px;
    }

    .meeting-controls button {
      margin-right: 10px;
      padding: 10px 18px;
      border: none;
      background-color: #1abc9c;
      color: white;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }

    .meeting-controls button:hover {
      background-color: #24d5b2;
    }

    #meetingForm label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
    }

    #meetingForm input {
      width: 100%;
      max-width: 500px;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    #meetingForm button {
      background-color: #28a745;
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 5px;
      cursor: pointer;
    }

    #meetingForm button:hover {
      background-color: #218838;
    }


    /* Optional spacing for consistency */
    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 40px 0 20px;
    }
    .meeting-btn {
  padding: 5px 12px;
  font-size: 14px;
  font-weight: 500;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  margin-right: 6px;
}

.edit-btn {
  background-color: #1abc9c; 
  color: #ffffff;
}

.edit-btn:hover {
  background-color: #21c6a5;
}

.delete-btn {
  background-color: #dc3545; /* Red */
  color: white;
}

.delete-btn:hover {
  background-color: #c82333;
}
/* FORCE borders even if global CSS overrides it */
.leave-table.modern-table,
.leave-table.modern-table th,
.leave-table.modern-table td {
  border: 1px solid #ccc !important;
  border-collapse: separate !important;
  border-spacing: 0 !important;
}
.leave-table.modern-table tr td:last-child,
.leave-table.modern-table tr th:last-child {
  border-right: 1px solid #ccc !important;
}

  </style>
</head>

<body>

  <!-- Top Navigation Bar -->
  <div class="top-nav">
    <div class="left-section">
      <img class="logo" src="LOGO_V1preview.png" alt="logo">
      <p class="company">JPSCUBE ENGINEERS</p>
      <div class="header-actions">
        <button class="icon-btn back-btn" onclick="goBack()">‚Üê</button>
        <button class="icon-btn home-btn" onclick="goHome()">üè†</button>
      </div>
    </div>
    <div class="right-section">
      <input type="text" placeholder="Search..." class="search-bar" />
      <div class="nav-icons">
        <span class="notification-icon" onclick="toggleNotification()">üîî</span>
        <span class="profile-icon" onclick="toggleProfileDropdown()">üë§ Admin</span>
      </div>
      <div id="notificationDropdown" class="dropdown-menu" style="display: none;">
        <a href="#">No new notifications</a>
      </div>
      <div id="profileDropdown" class="dropdown-menu" style="display: none;">
        <a href="#">Profile</a>
        <a href="login.html">Logout</a>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="Departments.html">Departments</a></li>
      <li><a href="WorkOrder.html">Work Order</a></li>
      <li><a href="Purchasing.html">Purchasing</a></li>
      <li><a href="Sales.html">Sales</a></li>
      <li><a href="inventory.html">Inventory</a></li>
      <li><a href="finance.html">Finance</a></li>
      <li><a href="employees.html">Employees</a></li>
      <li><a href="generatelogin.html">Generate Login Details</a></li>
      <li><a href="Companyinfo.html">Company Info</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <h1>Admin Department</h1>
    <h2>No. of Admins</h2>
    <table border="1" style="width: 61%; text-align: center;">
      <thead>
        <tr>
          <th>Sr No</th>
          <th>Name</th>
          <th>Emp ID</th>
          <th>Mobile No</th>
        </tr>
      </thead>
      <tbody id="adminTableBody">
        <!-- Admins will be added here -->
      </tbody>
    </table>
    <hr>
    <div class="meeting-section">
      <h2>Meeting Schedule</h2> <br>

      <div class="meeting-controls">
        <button onclick="toggleMeetingForm()">Add</button>
        <button onclick="loadMeetings()">Upcoming Meetings</button>
      </div>

      <!-- Meeting Form -->
      <div id="meetingForm" style="display:none;">
        <label>Topic of Discussion:</label>
        <input type="text" id="meetingTopic">

        <label>Meeting Date & Time:</label>
        <input type="datetime-local" id="meetingDateTime">

        <label>Assigned By:</label>
        <input type="text" id="assignedBy">

        <button onclick="addMeeting()">Done</button>
      </div>

      <!-- Upcoming Meetings Table -->
      <div id="meetingsSection" style="display:none;">
        <table class ="modern-table leave-table">
          <thead>
            <tr>
              <th>Topic</th>
              <th>Date & Time</th>
              <th>Assigned By</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="meetingsTableBody">
            <!-- Meetings will be listed here -->
          </tbody>
        </table>
      </div>
    </div>


    <!-- Firebase Scripts -->
    <script type="module">
      import { db } from "./firebase-init.js";
      import {
        collection,
        getDocs
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      window.addEventListener("DOMContentLoaded", async () => {
        const tableBody = document.getElementById("adminTableBody");
        if (!tableBody) return;

        try {
          const querySnapshot = await getDocs(collection(db, "employees"));

          let srNo = 1;
          querySnapshot.forEach((doc) => {
            const data = doc.data();

            // Log data to debug
            console.log("Checking doc:", data);

            // Check if department field exists and is "Admin"
            if (
              typeof data.department === "string" &&
              data.department.trim().toLowerCase() === "admin"
            ) {
              const row = document.createElement("tr");
              row.innerHTML = `
            <td>${srNo}</td>
            <td>${data.name || "-"}</td>
            <td>${data.empId || "-"}</td>
            <td>${data.contact || "-"}</td>
          `;
              tableBody.appendChild(row);
              srNo++;
            }
          });
        } catch (error) {
          console.error("Failed to fetch employees:", error);
        }
      });
      // Already importing: db, collection, getDocs
      import {
        addDoc
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      // Load meetings
      window.loadMeetings = async function () {
        const meetingsSection = document.getElementById("meetingsSection");
        const tableBody = document.getElementById("meetingsTableBody");
        tableBody.innerHTML = "";
        meetingsSection.style.display = "block";

        try {
          const querySnapshot = await getDocs(collection(db, "meetings"));
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const row = document.createElement("tr");
            const docId = doc.id; // needed for update/delete
            row.innerHTML = `
    <td contenteditable="true">${data.topic || "-"}</td>
    <td contenteditable="true">${data.datetime || "-"}</td>
    <td contenteditable="true">${data.assignedBy || "-"}</td>
    <td>
      <button class="meeting-btn edit-btn" onclick="updateMeeting('${doc.id}', this)">Edit</button>
      <button class="meeting-btn delete-btn" onclick="deleteMeeting('${doc.id}')">Delete</button>
    </td>
  `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("Failed to load meetings:", error);
        }
      };

      // Add a new meeting
      window.addMeeting = async function () {
        const topic = document.getElementById("meetingTopic").value.trim();
        const datetime = document.getElementById("meetingDateTime").value;
        const assignedBy = document.getElementById("assignedBy").value.trim();

        if (!topic || !datetime || !assignedBy) {
          alert("Please fill in all fields.");
          return;
        }

        try {
          await addDoc(collection(db, "meetings"), {
            topic,
            datetime,
            assignedBy
          });

          alert("Meeting added successfully!");
          document.getElementById("meetingTopic").value = "";
          document.getElementById("meetingDateTime").value = "";
          document.getElementById("assignedBy").value = "";
          document.getElementById("meetingForm").style.display = "none";
          loadMeetings(); // show updated list
        } catch (error) {
          console.error("Error adding meeting:", error.message, error);
          alert("Failed to add meeting.");
        }
      };

      // Toggle form visibility
      window.toggleMeetingForm = function () {
        const form = document.getElementById("meetingForm");
        const table = document.getElementById("meetingsSection");
        table.style.display = "none";
        form.style.display = (form.style.display === "none") ? "block" : "none";
      };

      // Required Firestore imports
      import {
        doc,
        updateDoc,
        deleteDoc
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

     window.updateMeeting = async function (docId, btn) {

  const row = btn.closest("tr");
  const editableCells = row.querySelectorAll("td[contenteditable]");

  // --- If clicking EDIT ---
  if (btn.textContent === "Edit") {

    // Lock ALL rows first
    document.querySelectorAll("#meetingsTableBody tr").forEach(tr => {
      tr.querySelectorAll("td[contenteditable]").forEach(td => {
        td.setAttribute("contenteditable", "false");
        td.style.backgroundColor = "";
      });
      const editBtn = tr.querySelector(".edit-btn");
      if (editBtn) editBtn.textContent = "Edit";
    });

    // Unlock ONLY this row
    editableCells.forEach(td => {
      td.setAttribute("contenteditable", "true");
      td.style.backgroundColor = "#fff7cc";
    });

    btn.textContent = "Save";
    return;
  }

  // --- If clicking SAVE ---
  const updatedData = {
    topic: editableCells[0].innerText.trim(),
    datetime: editableCells[1].innerText.trim(),
    assignedBy: editableCells[2].innerText.trim()
  };

  try {
    await updateDoc(doc(db, "meetings", docId), updatedData);
    alert("Meeting updated successfully!");
  } catch (err) {
    console.error("Error updating meeting:", err);
  }

  // Lock row again
  editableCells.forEach(td => {
    td.setAttribute("contenteditable", "false");
    td.style.backgroundColor = "";
  });

  btn.textContent = "Edit";
};

      // ‚ùå DELETE a meeting
      window.deleteMeeting = async function (docId) {
        if (!confirm("Are you sure you want to delete this meeting?")) return;

        try {
          await deleteDoc(doc(db, "meetings", docId));
          alert("Meeting deleted successfully!");
          loadMeetings(); // refresh table
        } catch (error) {
          console.error("Error deleting meeting:", error);
          alert("Failed to delete meeting.");
        }
      };

    </script>

    <!-- JS Scripts -->
    <script>
      function goBack() {
        window.history.back();
      }

      function goHome() {
        window.location.href = 'index.html';
      }

      function toggleNotification() {
        const notificationDropdown = document.getElementById('notificationDropdown');
        const profileDropdown = document.getElementById('profileDropdown');
        profileDropdown.style.display = 'none';
        notificationDropdown.style.display = (notificationDropdown.style.display === 'block') ? 'none' : 'block';
      }

      function toggleProfileDropdown() {
        const notificationDropdown = document.getElementById('notificationDropdown');
        const profileDropdown = document.getElementById('profileDropdown');
        notificationDropdown.style.display = 'none';
        profileDropdown.style.display = (profileDropdown.style.display === 'block') ? 'none' : 'block';
      }

      document.addEventListener('click', function (event) {
        const notificationIcon = document.querySelector('.notification-icon');
        const profileIcon = document.querySelector('.profile-icon');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const profileDropdown = document.getElementById('profileDropdown');

        if (!notificationIcon.contains(event.target) && !notificationDropdown.contains(event.target)) {
          notificationDropdown.style.display = 'none';
        }

        if (!profileIcon.contains(event.target) && !profileDropdown.contains(event.target)) {
          profileDropdown.style.display = 'none';
        }
      });

      // Active Link Highlight
      const currentPage = window.location.pathname.split("/").pop();
      const sidebarLinks = document.querySelectorAll(".sidebar ul li a");

      sidebarLinks.forEach(link => {
        if (link.getAttribute("href") === currentPage) {
          link.classList.add("active");
        }
      });
    </script>

    <script src="js/rolepermission.js"></script>

</body>

</html>