<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Employees</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script>
    // Placed in <head> to prevent page from loading unauthorized content      
    if (localStorage.getItem("isLoggedIn") !== "true") {
      window.location.href = "login.html";
    }
  </script>

</head>

<body>
  <!-- Top Navigation Bar -->
  <div class="top-nav">
    <div class="left-section">
      <img class="logo" src="LOGO_V1preview.png" alt="logo">
      <p class="company">JPSCUBE ENGINEERS</p>
      <div class="header-actions">
        <button class="icon-btn back-btn" onclick="goBack()">‚Üê</button>
        <button class="icon-btn home-btn" onclick="goHome()">üè†</button>
      </div>
    </div>
    <div class="right-section">
      <input type="text" placeholder="Search..." class="search-bar" />
      <div class="nav-icons">
        <span class="notification-icon">üîî</span>
        <span class="profile-icon">üë§ Admin</span>
      </div>
    </div>
  </div>
  <div class="sidebar">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="Departments.html">Departments</a></li>
      <li><a href="WorkOrder.html">Work Order</a></li>
      <li><a href="Purchasing.html">Purchasing</a></li>
      <li><a href="Sales.html">Sales</a></li>
      <li><a href="inventory.html">Inventory</a></li>
      <li><a href="finance.html">Finance</a></li>
      <li><a href="employees.html">Employees</a></li>
      <li><a href="generatelogin.html">Generate Login Details</a></li>
      <li><a href="Companyinfo.html">Company Info</a></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>Employees</h1>
    <p>Manage employee records here.</p> <br>
    <form id="employeeForm" class="employee-form">
      <input type="text" placeholder="Username" required id="username" />
      <input type="text" placeholder="Name" required id="name" />
      <input type="text" placeholder="Employee ID" required id="empId" />
      <input type="tel" placeholder="Contact" required id="contact" />
      <input type="tel" placeholder="Alt Contact" required id="altContact" />
      <input type="text" placeholder="Address" required id="address" />
      <select id="bloodGroup" required>
        <option value="">Blood Group</option>
        <option value="A+">A+</option>
        <option value="A-">A-</option>
        <option value="B+">B+</option>
        <option value="B-">B-</option>
        <option value="AB+">AB+</option>
        <option value="AB-">AB-</option>
        <option value="O+">O+</option>
        <option value="O-">O-</option>
      </select>
      <input type="text" placeholder="Bank Acc No" required id="bank" pattern="\d{9,18}" maxlength="18" />
      <input type="text" placeholder="Aadhar No" required id="aadhar" />
      <select id="department" required>
        <option value="">Select Department</option>
        <option value="Admin">Admin</option>
        <option value="HR">HR</option>
        <option value="Technical">Technical</option>
        <option value="Production">Production</option>
        <option value="Sales">Sales</option>
        <option value="Store">Store</option>
      </select>
      <button type="submit">Add Employee</button>
    </form>

    <!-- View Button & Filters -->
    <button id="viewBtn" class="submit-btn">View Employees</button>

    <div id="employeeTableSection" style="display: none;">
      <div class="filter-controls">
        <input type="text" id="filterName" placeholder="Search by Name" />
        <select id="filterBlood">
          <option value="">All Blood Groups</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select>
        <select id="filterDept">
          <option value="">All Departments</option>
          <option value="Admin">Admin</option>
          <option value="HR">HR</option>
          <option value="Technical">Technical</option>
          <option value="Production">Production</option>
          <option value="Sales">Sales</option>
          <option value="Store">Store</option>
        </select>
      </div>

      <table class="employee-table">
        <thead>
          <tr>
            <th>UserName</th>
            <th>Name</th>
            <th>Employee ID</th>
            <th>Contact</th>
            <th>Alt Contact</th>
            <th>Address</th>
            <th>Blood Group</th>
            <th>Bank Acc No</th>
            <th>Aadhar No</th>
            <th>Department</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Employee rows will be added here -->
        </tbody>
      </table>
    </div>

    <script type="module">
      window.goBack = () => window.history.back();
      window.goHome = () => window.location.href = 'index.html';

      import { db } from './firebase-init.js';
      import { collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      function goBack() {
        window.history.back(); // Go to previous page
      }

      function goHome() {
        window.location.href = 'index.html';
      }

      const currentPage = window.location.pathname.split("/").pop();
      const sidebarLinks = document.querySelectorAll(".sidebar ul li a");

      sidebarLinks.forEach(link => {
        if (link.getAttribute("href") === currentPage) {
          link.classList.add("active");
        }
      });

      const form = document.getElementById("employeeForm");
      const table = document.querySelector(".employee-table tbody");

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const contact = document.getElementById("contact").value.replace(/\s/g, "").trim();
        const altContact = document.getElementById("altContact").value.replace(/\s/g, "").trim();
        const phoneRegex = /^\d{10}$/;

        if (!phoneRegex.test(contact)) {
          alert("Contact must be number and exactly 10 digits.");
          return;
        }

        if (altContact && !phoneRegex.test(altContact)) {
          alert("Alt Contact must be number and exactly 10 digits.");
          return;
        }

        if (contact === altContact) {
          alert("Alternate contact cannot be the same as primary contact.");
          return;
        }

        const bank = document.getElementById("bank").value.trim();
        const bankRegex = /^\d{9,18}$/;

        if (!bankRegex.test(bank)) {
          alert("Bank Account No must be numeric and 9-18 digits long.");
          return;
        }
        const username = document.getElementById("username").value.trim();
        const name = document.getElementById("name").value;
        const empId = document.getElementById("empId").value.trim();
        const address = document.getElementById("address").value;
        const bloodGroup = document.getElementById("bloodGroup").value;
        const aadhar = document.getElementById("aadhar").value;
        const department = document.getElementById("department").value;

        // Save to Firestore
        try {
          await addDoc(collection(db, "employees"), {
            username,
            name,
            empId,
            contact,
            altContact,
            address,
            bloodGroup,
            bank,
            aadhar,
            department
          });

          // Also add to UI table
          const newRow = document.createElement("tr");
          newRow.innerHTML = `
        <td>${username}</td>
        <td>${name}</td>
        <td>${empId}</td>
        <td>${contact}</td>
        <td>${altContact}</td>
        <td>${address}</td>
        <td>${bloodGroup}</td>
        <td>${bank}</td>
        <td>${aadhar}</td>
        <td>${department}</td>
        <td>
          <button class="edit-btn">Edit</button>
          <button class="delete-btn">Delete</button>
        </td>
      `;
          table.appendChild(newRow);
          form.reset();
          alert("Employee added to Firebase successfully!");
        } catch (error) {
          console.error("Error adding document: ", error);
          alert("Failed to save to Firestore!");
        }
      });

      // Format Aadhar
      const aadharInput = document.getElementById("aadhar");
      aadharInput.addEventListener("input", () => {
        let value = aadharInput.value.replace(/\D/g, "").slice(0, 12);
        aadharInput.value = value.match(/.{1,4}/g)?.join(" ") || "";
      });

      // Format Contact
      const contactInput = document.getElementById("contact");
      contactInput.addEventListener("input", () => {
        let value = contactInput.value.replace(/\D/g, "").slice(0, 10);
        contactInput.value = value.length > 5 ? value.slice(0, 5) + " " + value.slice(5) : value;
      });

      // Format Alt Contact
      const altContactInput = document.getElementById("altContact");
      altContactInput.addEventListener("input", () => {
        let value = altContactInput.value.replace(/\D/g, "").slice(0, 10);
        altContactInput.value = value.length > 5 ? value.slice(0, 5) + " " + value.slice(5) : value;
      });

      // üîÅ Fetch and display all employees from Firestore on page load
      async function fetchEmployees() {
        const snapshot = await getDocs(collection(db, "employees"));
        snapshot.forEach(doc => {
          const data = doc.data();
          const newRow = document.createElement("tr");

          newRow.setAttribute("data-id", doc.id); // üÜï save document ID on row
          newRow.innerHTML = `
  <td contenteditable="false">${data.username || ""}</td>
  <td contenteditable="false">${data.name || ""}</td>
  <td contenteditable="false">${data.empId || ""}</td>
  <td contenteditable="false">${data.contact || ""}</td>
  <td contenteditable="false">${data.altContact || ""}</td>
  <td contenteditable="false">${data.address || ""}</td>
  <td contenteditable="false">${data.bloodGroup || ""}</td>
  <td contenteditable="false">${data.bank || ""}</td>
  <td contenteditable="false">${data.aadhar || ""}</td>
  <td contenteditable="false">${data.department || ""}</td>
  <td>
    <button class="edit-btn">Edit</button>
    <button class="save-btn" style="display:none;">Save</button>
    <button class="delete-btn">Delete</button>
    </td>
    `;
          table.appendChild(newRow);
        });
      }

      // üëá Call fetched employees
      let dataFetched = false;

      const viewBtn = document.getElementById("viewBtn");
      const tableSection = document.getElementById("employeeTableSection");

      viewBtn.addEventListener("click", async () => {
        const isVisible = tableSection.style.display === "block";

        if (isVisible) {
          tableSection.style.display = "none";
          viewBtn.textContent = "View Employees";
        } else {
          tableSection.style.display = "block";
          viewBtn.textContent = "Hide Employees";

          if (!dataFetched) {
            await fetchEmployees(); // fetch only once
            dataFetched = true;
          }
        }
      });
      table.addEventListener("click", async function (e) {
        const row = e.target.closest("tr");
        const docId = row.getAttribute("data-id");
        const cells = row.querySelectorAll("td[contenteditable]");

        if (e.target.classList.contains("edit-btn")) {
          cells.forEach(cell => cell.setAttribute("contenteditable", "true"));
          row.querySelector(".edit-btn").style.display = "none";
          row.querySelector(".save-btn").style.display = "inline";
        }

        if (e.target.classList.contains("save-btn")) {
          const updatedData = {
            username: cells[0].innerText.trim(),
            name: cells[1].innerText.trim(),
            empId: cells[2].innerText.trim(),
            contact: cells[3].innerText.trim(),
            altContact: cells[4].innerText.trim(),
            address: cells[5].innerText.trim(),
            bloodGroup: cells[6].innerText.trim(),
            bank: cells[7].innerText.trim(),
            aadhar: cells[8].innerText.trim(),
            department: cells[9].innerText.trim(),
          };

          try {
            const docRef = doc(db, "employees", docId);
            await updateDoc(docRef, updatedData);
            alert("‚úÖ Updated successfully");

            cells.forEach(cell => cell.setAttribute("contenteditable", "false"));
            row.querySelector(".edit-btn").style.display = "inline";
            row.querySelector(".save-btn").style.display = "none";
          } catch (error) {
            console.error("Update failed:", error);
            alert("‚ùå Failed to update");
          }
        }

        if (e.target.classList.contains("delete-btn")) {
          const confirmDelete = confirm("Are you sure you want to delete this employee?");
          if (!confirmDelete) return;

          try {
            await deleteDoc(doc(db, "employees", docId));
            row.remove();
            alert("üóëÔ∏è Deleted successfully");
          } catch (err) {
            console.error("Delete failed:", err);
            alert("‚ùå Failed to delete");
          }
        }
      });

      // Filtering logic for Name, Blood Group, and Department
      function applyFilters() {
        const nameVal = document.getElementById("filterName").value.toLowerCase();
        const bloodVal = document.getElementById("filterBlood").value.toLowerCase();
        const deptVal = document.getElementById("filterDept").value.toLowerCase();

        document.querySelectorAll(".employee-table tbody tr").forEach(row => {
          const name = row.children[1].innerText.toLowerCase();        // Name column
          const blood = row.children[6].innerText.toLowerCase();       // Blood Group column
          const dept = row.children[9].innerText.toLowerCase();        // Department column

          const show =
            (!nameVal || name.includes(nameVal)) &&
            (!bloodVal || blood === bloodVal) &&
            (!deptVal || dept === deptVal);

          row.style.display = show ? "" : "none";
        });
      }
      // event listeners to the filters
      document.getElementById("filterName").addEventListener("input", applyFilters);
      document.getElementById("filterBlood").addEventListener("change", applyFilters);
      document.getElementById("filterDept").addEventListener("change", applyFilters);

    </script>
    <script src="js/rolepermission.js"></script>
</body>

</html>